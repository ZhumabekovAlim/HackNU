package main

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io/ioutil"
	"net/http"
)

func textHandler(w http.ResponseWriter, r *http.Request) {
	r.ParseForm()
	text := r.FormValue("text")

	data := map[string]interface{}{
		"messages": []map[string]interface{}{
			{"role": "user", "content": "Берілген мәтіннің басты ойы қандай \n\"Шоқан - Қазақтың тұңғыш ғалымы туралы мәтін Шоқан Шыңғысұлы Уәлиханов – қазақтың ұлы ғалымы, шығыстанушы, тарихшы, фольклоршы, этнограф, географ, ағартушы. Шоқан 1835 жылдың қараша айында Құсмұрын бекетінде қазіргі Қостанай облысы Әулиекөл ауданындағы Құсмұрын жерінде атақты аға сұлтан Шыңғыс Уәлиханов отбасында дүниеге келген. Әкесі Шыңғыс Уәлиханұлы аға сұлтан болған. Шоқанның өз атасы Уәли Орта жүздің ханы болған. Арғы атасы – Қазақ ордасының Ұлы ханы Абылай, Шоқан – оның шөбересі. Шоқанның шын есімі – Мұхаммед-Қанафия. Шоқан әкесі ашқан ауыл мектебінде хат таныған. Шоқан 12 жасына дейін Құсмұрындағы мектепте оқып, мұсылман діні ілімімен танысты. Шоқан ауылдық бастауыш мектепте оқып жүріп-ақ араб, парсы, шағатай тілдерінің негізін үйреніп алды. 1847 жылы 12 жасар Шоқанды әкесі сол кездегі ең таңдаулы оқу орны болып есептелген Сібір кадеті корпусына оқуға орналастырады. Шоқанның бүкіл келешегі мен ғылым, өнер жолындағы талантын ашуда бұл оқу орнының маңызы ерекше болды. Бұл жабық әскери оқу орны болғанымен, көптеген пәндер әскери сабақтарға қоса, орыс, батыс әдебиеті, географиясы мен тарихы, философия, физика, математика негіздері, шетел тілдері оқытылған. Кадет корпусына алғаш оқуға түскен кезде Шоқан орыс тілін білмесе де, өзінің зеректігімен тілді тез үйренді. Шоқанның 51 корпуста бірге оқыған Г.Н. Потанин: «Өзінің орыс жолдастарын басып озып, Шоқан тез жетілді… Оған талайлар-ақ назар аударды. Ол сондай қабілетті еді және оқу орнына түспей тұрып ақ сурет сала білетін», – дейді. «Жоңғария очерктері», «Қазақтың халық поэзиясының түрлері туралы», «Қытай империясының батыс өлкесі және Құлжа қаласы» т.б. еңбектерін жазды. Табиғатты және ел тұрмысын Шоқан жазушылық шеберлікпен суреттейді. Осыдан барып оны орыс достары «Қазақ тақырыбына жазатын орыс жазушысы» деп атаған. Тарих, география саласындағы даңқы Петербург ғалымдарына да жетіп, 20-дан жаңа асқан жас Шоқанды Орыс География қоғамының толық мүшесі етіп сайлайды. Шоқан Уәлиханов Қазақстан мен Орта Азия халықтарының тарихы мен мәдениетін зерттеуге орасан зор үлес қосты. Аса көрнекті қазақ ғалымы өте ауқымды ғылыми-шығармашылық мұра қалдырды. Оның «Абылай», «Қырғыздар туралы жазбалар», «Ыстықкөл күнделіктері», «Үлкен орда қырғыз-қайсақтары туралы» т.б. еңбектері өте құнды саналады. Шоқанның қазақтардың, сондай-ақ Орта Азия халықтарының өмірінен салған 150-ден астам суреттері сақталған. Ол қазақтардың алғашқы кәсіби суретшілерінің бірі. Ш. Уәлихановқа орнатылған ескерткіш бар. Жазушылар Г. Марков, С. Мұқанов Шоқан туралы роман жазған. «Мәдени мұра» бағдарламасы бойынша 2010 жылы «Ш.Уәлиханов» көп томдық шығармалар жинағының 6 томдығы жарық көрді.\"\n\n және оны берілген жауаппен салыстырып, неше пайыз келетінін анықта ? (тек қазақ тілінде жауап бер)" + text},
		},
		"model": "gpt-4-turbo",
	}

	jsonData, err := json.Marshal(data)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	req, err := http.NewRequest("POST", url, bytes.NewReader(jsonData))
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}
	req.Header.Add("Content-Type", "application/json")
	req.Header.Add("Authorization", "Bearer "+apiKey)

	client := &http.Client{}
	resp, err := client.Do(req)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}
	defer resp.Body.Close()
	body, err := ioutil.ReadAll(resp.Body)
	if err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	var response CompletionResponse
	if err := json.Unmarshal(body, &response); err != nil {
		http.Error(w, err.Error(), http.StatusInternalServerError)
		return
	}

	if len(response.Choices) > 0 {
		fmt.Fprintf(w, response.Choices[0].Message.Content)
	} else {
		fmt.Fprint(w, "Ошибка вывода")
	}
}
